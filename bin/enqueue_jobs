#!/usr/bin/env ruby

require 'time'

require_relative "../lib/perf_check_daemon/configure"
require_relative "../lib/perf_check_daemon/job"
require_relative "../lib/perf_check_daemon/github_poller"

poller = PerfCheckDaemon::GithubPoller.new(github)

max_notification_time = poller.poll

poller.jobs.each do |job|
  logger.info("job: " + job.to_json)
  mention = job.delete(:github_holder)
  Resque.enqueue(PerfCheckDaemon::Job, job)
  poller.log_mention(mention, job[:arguments])
end

if max_notification_time
  api("repos/#{github.repo}/notifications",
      { last_read_at: (max_notification_time+1).iso8601 },
      put: true)
end

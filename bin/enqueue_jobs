#!/usr/bin/env ruby

require 'time'

require_relative "../lib/configure"
require_relative "../lib/perf_check_job"
require_relative "../lib/github_poller"

poller = GithubPoller.new(github)

max_notification_time = poller.poll

poller.jobs.each do |job|
  logger.info("job: " + job.to_json)
  Resque.enqueue(PerfCheckJob, job)
end

if max_notification_time
  api("repos/#{github.repo}/notifications",
      { last_read_at: (max_notification_time+1).iso8601 },
      put: true)
end
